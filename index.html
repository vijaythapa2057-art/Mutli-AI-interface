<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vijaya AI Hub - Unified Comparison</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, limit, getDocs, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase references
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.query = query;
        window.limit = limit;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.setLogLevel = setLogLevel;
    </script>

    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0f172a; /* Slate-900 */
            color: #f1f5f9; /* Slate-100 */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #0d9488; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        
        /* Animation for response cards */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card styles for visual punch */
        .response-card {
            animation: fadeIn 0.6s ease-out;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Model specific color classes */
        .color-blue { border-left-color: #3b82f6; }
        .color-emerald { border-left-color: #10b981; }
        .color-purple { border-left-color: #a855f7; }
        .color-pink { border-left-color: #ec4899; }
        .color-yellow { border-left-color: #f59e0b; }

        /* Custom spinner for loading state */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-teal-400">AI Model Comparison Hub</h1>
            <p class="text-teal-200 mt-2">Compare model outputs side-by-side using a single prompt.</p>
            <div id="auth-status" class="text-sm mt-2 text-slate-400">
                <span id="user-id-display">Loading User...</span> | <span id="auth-state">Authenticating...</span>
            </div>
        </header>

        <!-- Controls Panel -->
        <div id="controls-panel" class="bg-slate-800 p-6 rounded-xl shadow-2xl mb-10 border border-slate-700">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Prompt Input -->
                <div class="lg:col-span-2">
                    <label for="prompt-input" class="block text-sm font-medium mb-2 text-teal-300">Your Prompt</label>
                    <textarea id="prompt-input" rows="3" placeholder="Enter your query here (e.g., 'Explain how a neural network works in simple terms.')" 
                              class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-teal-500 focus:border-teal-500 transition duration-150 resize-none"
                    ></textarea>
                </div>

                <!-- Model Selection -->
                <div>
                    <div class="text-sm font-medium mb-2 text-teal-300">Select Models (Min 1)</div>
                    <div id="model-selection" class="space-y-2 text-sm">
                        <!-- Checkboxes will be dynamically added here -->
                        <label class="flex items-center space-x-2 text-blue-300">
                            <input type="checkbox" name="model" value="flash" class="form-checkbox text-blue-500 rounded model-checkbox" checked>
                            <span>Gemini Flash</span>
                        </label>
                        <label class="flex items-center space-x-2 text-emerald-300">
                            <input type="checkbox" name="model" value="haiku" class="form-checkbox text-emerald-500 rounded model-checkbox">
                            <span>Claude Haiku</span>
                        </label>
                        <label class="flex items-center space-x-2 text-purple-300">
                            <input type="checkbox" name="model" value="opus" class="form-checkbox text-purple-500 rounded model-checkbox">
                            <span>Claude Opus</span>
                        </label>
                        <label class="flex items-center space-x-2 text-pink-300">
                            <input type="checkbox" name="model" value="gpt4o" class="form-checkbox text-pink-500 rounded model-checkbox">
                            <span>GPT-4o</span>
                        </label>
                        <label class="flex items-center space-x-2 text-yellow-300">
                            <input type="checkbox" name="model" value="llama3" class="form-checkbox text-yellow-500 rounded model-checkbox">
                            <span>Llama 3</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <div class="mt-6 flex justify-end">
                <button id="generate-button" 
                        class="px-8 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-lg hover:bg-teal-500 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" 
                        disabled>
                    Generate Comparisons
                </button>
            </div>
        </div>

        <!-- Responses and History Container -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Response Container (2/3 width on desktop) -->
            <div class="lg:col-span-3">
                <h2 class="text-2xl font-bold text-teal-400 mb-4">Generated Responses</h2>
                <div id="response-container" class="space-y-6 min-h-[100px] border-l-4 border-slate-700 pl-4">
                    <p class="text-slate-500">Enter a prompt and select at least one model to begin a comparison.</p>
                </div>
            </div>

            <!-- History Container (1/3 width on desktop) -->
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-teal-400 mb-4">Comparison History</h2>
                <div id="history-container" class="space-y-3 p-4 bg-slate-800 rounded-xl min-h-[200px] border border-slate-700">
                    <p class="text-sm text-slate-500" id="history-loading">Loading history...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables for Firebase and App
        let db;
        let auth;
        let userId = 'default-user'; // Fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI Elements
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const modelCheckboxes = document.querySelectorAll('.model-checkbox');
        const responseContainer = document.getElementById('response-container');
        const historyContainer = document.getElementById('history-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const authStateDisplay = document.getElementById('auth-state');

        // Model Data (Simulated, as actual model calls are not implemented here)
        const models = {
            'flash': { name: 'Gemini Flash', colorClass: 'color-blue', response: 'This is a placeholder response from Gemini Flash.' },
            'haiku': { name: 'Claude Haiku', colorClass: 'color-emerald', response: 'This is a placeholder response from Claude Haiku.' },
            'opus': { name: 'Claude Opus', colorClass: 'color-purple', response: 'This is a placeholder response from Claude Opus.' },
            'gpt4o': { name: 'GPT-4o', colorClass: 'color-pink', response: 'This is a placeholder response from GPT-4o.' },
            'llama3': { name: 'Llama 3', colorClass: 'color-yellow', response: 'This is a placeholder response from Llama 3.' },
        };

        // --- Firebase Initialization and Auth ---

        async function initializeAuth() {
            if (!firebaseConfig || !window.initializeApp) {
                console.error("Firebase configuration or initialization functions are missing.");
                authStateDisplay.textContent = 'Auth Failed: No Config';
                return;
            }
            
            setLogLevel('debug'); // Enable Firestore logging

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                        authStateDisplay.textContent = 'Authenticated';
                        // Start listening to history once authenticated
                        loadComparisonHistory();
                        updateButtonStatus();
                    } else {
                        userId = crypto.randomUUID();
                        userIdDisplay.textContent = 'Anonymous';
                        authStateDisplay.textContent = 'Unauthenticated';
                        updateButtonStatus();
                    }
                });
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                authStateDisplay.textContent = `Auth Error: ${error.code}`;
            }
        }

        // --- Firestore Operations ---
        
        function getHistoryCollectionRef() {
            if (!db) return null;
            // Public path for collaborative/shared data (History is public)
            return collection(db, 'artifacts', appId, 'public', 'data', 'comparisons');
        }

        async function saveComparison(prompt, responses) {
            const comparisonsRef = getHistoryCollectionRef();
            if (!comparisonsRef) return console.error("Firestore DB not ready.");

            try {
                await setDoc(doc(comparisonsRef), {
                    prompt: prompt,
                    responses: responses,
                    timestamp: serverTimestamp(),
                    userId: userId,
                });
            } catch (error) {
                console.error("Error writing comparison to Firestore:", error);
                showMessage('Error saving comparison history.', 'error');
            }
        }

        function loadComparisonHistory() {
            const comparisonsRef = getHistoryCollectionRef();
            if (!comparisonsRef) return;

            const q = query(comparisonsRef, orderBy('timestamp', 'desc'), limit(10));
            
            onSnapshot(q, (snapshot) => {
                historyContainer.innerHTML = '';
                if (snapshot.empty) {
                    historyContainer.innerHTML = '<p class="text-sm text-slate-500">No comparisons yet. Be the first!</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const historyItem = document.createElement('div');
                    historyItem.className = 'p-3 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition duration-150';
                    
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'N/A';
                    
                    historyItem.innerHTML = `
                        <p class="text-teal-300 font-semibold truncate">${data.prompt}</p>
                        <p class="text-xs text-slate-400 mt-1">
                            ${data.responses.length} models | ${time}
                        </p>
                    `;
                    historyItem.onclick = () => displayHistoryItem(data);
                    historyContainer.appendChild(historyItem);
                });
            }, (error) => {
                console.error("Error listening to history snapshot:", error);
                document.getElementById('history-loading').textContent = 'Failed to load history.';
            });
        }

        function displayHistoryItem(data) {
            responseContainer.innerHTML = '';
            responseContainer.innerHTML = `
                <div class="p-4 mb-4 bg-slate-700 rounded-lg">
                    <h3 class="text-xl font-bold text-teal-300 mb-2">History Prompt:</h3>
                    <p class="text-slate-200">${data.prompt}</p>
                </div>
            `;
            
            data.responses.forEach(responseItem => {
                 const tempDiv = document.createElement('div');
                 // Re-use the card creation function but pass a fixed timestamp for history
                 tempDiv.innerHTML = createResponseCard(responseItem, data.prompt, data.timestamp ? new Date(data.timestamp.toDate()) : new Date()).trim();
                 if (tempDiv.firstChild) {
                      responseContainer.appendChild(tempDiv.firstChild);
                 }
            });
        }

        // --- UI and Utility Functions ---

        function showMessage(message, type = 'info') {
            const alertHtml = `
                <div class="p-3 mb-4 rounded-lg text-sm ${type === 'error' ? 'bg-red-900 text-red-100' : 'bg-blue-900 text-blue-100'}">
                    ${message}
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alertHtml;
            responseContainer.prepend(tempDiv.firstChild);
            
            // Auto-remove messages after 5 seconds
            setTimeout(() => tempDiv.firstChild.remove(), 5000);
        }

        function updateButtonStatus() {
            const prompt = promptInput.value.trim();
            const selectedModels = Array.from(modelCheckboxes).filter(cb => cb.checked).length;
            
            // FIX: Check if 'auth' is initialized and user is authenticated. 
            // During initial load, 'auth' may be set but 'currentUser' may still be null while onAuthStateChanged is running.
            const isAuthChecked = auth && auth.currentUser !== null;
            const isReady = prompt.length > 0 && selectedModels > 0 && isAuthChecked;
            
            generateButton.disabled = !isReady;
            
            if (!auth || !auth.currentUser) {
                generateButton.textContent = 'Authenticating...';
            } else if (!isReady) {
                generateButton.textContent = 'Select Model(s) & Enter Prompt';
            } else {
                generateButton.textContent = 'Generate Comparisons';
            }
        }

        function createResponseCard(data, prompt, timestamp) {
            const timeString = timestamp instanceof Date ? timestamp.toLocaleTimeString() : new Date().toLocaleTimeString();
            
            return `
                <div class="response-card p-5 bg-slate-800 rounded-xl border-l-4 ${data.colorClass} shadow-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-slate-100">${data.name}</h3>
                        <span class="text-xs text-slate-400">${timeString}</span>
                    </div>
                    <p class="text-sm text-slate-300 whitespace-pre-wrap">${data.response}</p>
                    <div class="mt-4 pt-3 border-t border-slate-700 text-xs text-slate-500">
                        Model Key: ${data.modelKey}
                    </div>
                </div>
            `;
        }
        
        // --- Main Generation Logic (Placeholder) ---

        generateButton.addEventListener('click', () => {
            const prompt = promptInput.value.trim();
            const selectedModels = Array.from(modelCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (!prompt || selectedModels.length === 0) {
                showMessage('Please enter a prompt and select at least one model.', 'error');
                return;
            }

            responseContainer.innerHTML = `
                <div class="flex items-center text-teal-300">
                    <div class="loader"></div>
                    Generating responses for ${selectedModels.length} models...
                </div>
            `;
            
            // Simulate API call delay and rendering
            setTimeout(() => {
                responseContainer.innerHTML = '';
                const comparisonTimestamp = new Date();
                let generatedResponses = [];

                // Sort models alphabetically for consistent rendering order
                selectedModels.sort();
                
                selectedModels.forEach(modelKey => {
                    const modelData = models[modelKey];
                    const responseItem = {
                        modelKey: modelKey,
                        name: modelData.name,
                        colorClass: modelData.colorClass,
                        // Simulate a slightly personalized response
                        response: `${modelData.response}\n\nThis response addresses the prompt: "${prompt}".`,
                    };
                    generatedResponses.push(responseItem);

                    setTimeout(() => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = createResponseCard(responseItem, prompt, comparisonTimestamp).trim();
                        if (tempDiv.firstChild) {
                             responseContainer.appendChild(tempDiv.firstChild);
                        }
                    }, selectedModels.indexOf(modelKey) * 150); 
                });

                // Save the comparison to Firestore
                saveComparison(prompt, generatedResponses);
                
            }, 1000); // Main delay before starting to render
        });

        // Event listeners for real-time status update
        promptInput.addEventListener('input', updateButtonStatus);
        modelCheckboxes.forEach(cb => cb.addEventListener('change', updateButtonStatus));
        
        // Initialize Auth and button status on load
        window.onload = initializeAuth;

    </script>
</body>
</html>
